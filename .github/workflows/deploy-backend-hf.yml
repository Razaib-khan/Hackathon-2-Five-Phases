name: Deploy Backend to Hugging Face Hub

on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-hf.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Hugging Face Hub CLI
        run: pip install huggingface_hub

      - name: Create Hugging Face Space
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          # Create the space directory structure
          mkdir -p hf-space/app
          cp -r backend/* hf-space/app/

          # Create the required Space configuration
          cat > hf-space/README.md << EOF
          ---
          title: Todo App Backend
          emoji: ðŸ“
          colorFrom: blue
          colorTo: purple
          sdk: docker
          ---

          # Todo App Backend

          This is the backend for the Todo application.
          EOF

          # Create Dockerfile for the Space
          cat > hf-space/Dockerfile << EOF
          FROM python:3.11-slim

          WORKDIR /app

          COPY app/requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt

          COPY app/ .

          EXPOSE 8000

          CMD ["uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "8000"]
          EOF

          # Initialize git in the space directory
          cd hf-space
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add all files and commit
          git add .
          git commit -m "Initial commit: Todo backend"

          # Push to Hugging Face Space
          git remote add origin https://oauth2:${{ secrets.HF_ACCESS_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_SPACE_REPO_ID }}
          git push -u origin main --force
        env:
          HF_ACCESS_TOKEN: ${{ secrets.HF_ACCESS_TOKEN }}
          HF_SPACE_REPO_ID: ${{ secrets.HF_SPACE_REPO_ID }}

  deploy-direct:
    runs-on: ubuntu-latest
    environment: production
    if: ${{ !secrets.HF_SPACE_REPO_ID || secrets.HF_SPACE_REPO_ID == '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
        working-directory: .

      - name: Run tests
        run: |
          pip install pytest pytest-cov
          python -m pytest backend/tests/ -v
        working-directory: .
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}

      - name: Deploy to Hugging Face using API
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          # Use Hugging Face API to update the space
          pip install requests

          python << 'EOF'
          import os
          import requests
          import zipfile
          import io

          # Configuration
          hf_token = os.environ['HF_ACCESS_TOKEN']
          repo_id = os.environ['HF_SPACE_REPO_ID'] or os.environ.get('GITHUB_REPOSITORY', '').replace('/', '/')
          backend_dir = 'backend'

          headers = {
              'Authorization': f'Bearer {hf_token}'
          }

          # Create a zip of the backend directory
          zip_buffer = io.BytesIO()
          with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
              for root, dirs, files in os.walk(backend_dir):
                  for file in files:
                      file_path = os.path.join(root, file)
                      arc_path = os.path.relpath(file_path, backend_dir)
                      zip_file.write(file_path, arc_path)

          zip_buffer.seek(0)

          # Upload to Hugging Face Space
          upload_url = f'https://huggingface.co/api/spaces/{repo_id}/upload'
          files = {'file': ('backend.zip', zip_buffer, 'application/zip')}
          response = requests.post(upload_url, headers=headers, files=files)

          if response.status_code == 200:
              print(f'Successfully uploaded backend to {repo_id}')
          else:
              print(f'Failed to upload: {response.status_code} - {response.text}')
          EOF
        env:
          HF_ACCESS_TOKEN: ${{ secrets.HF_ACCESS_TOKEN }}
          HF_SPACE_REPO_ID: ${{ secrets.HF_SPACE_REPO_ID }}