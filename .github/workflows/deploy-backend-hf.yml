<<<<<<< HEAD
name: Deploy Backend to Hugging Face Spaces

on:
  push:
    branches: ["main"]
    paths:
      - 'backend/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - 'README.md'
      - '.github/workflows/deploy-backend-hf.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Backend to Hugging Face
=======
name: Deploy Backend to Hugging Face Hub

on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-hf.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-latest
>>>>>>> 001-fullstack-todo-app
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
<<<<<<< HEAD
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
=======

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Hugging Face Hub CLI
        run: pip install huggingface_hub

      - name: Create Hugging Face Space
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          # Create the space directory structure
          mkdir -p hf-space/app
          cp -r backend/* hf-space/app/

          # Create the required Space configuration
          cat > hf-space/README.md << EOF
          ---
          title: Todo App Backend
          emoji: ðŸ“
          colorFrom: blue
          colorTo: purple
          sdk: docker
          ---

          # Todo App Backend

          This is the backend for the Todo application.
          EOF

          # Create Dockerfile for the Space
          cat > hf-space/Dockerfile << EOF
          FROM python:3.11-slim

          WORKDIR /app

          COPY app/requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt

          COPY app/ .

          EXPOSE 8000

          CMD ["uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "8000"]
          EOF

          # Initialize git in the space directory
          cd hf-space
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add all files and commit
          git add .
          git commit -m "Initial commit: Todo backend"

          # Push to Hugging Face Space
          git remote add origin https://oauth2:${{ secrets.HF_ACCESS_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_SPACE_REPO_ID }}
          git push -u origin main --force
        env:
          HF_ACCESS_TOKEN: ${{ secrets.HF_ACCESS_TOKEN }}
          HF_SPACE_REPO_ID: ${{ secrets.HF_SPACE_REPO_ID }}

  deploy-direct:
    runs-on: ubuntu-latest
    environment: production
    if: ${{ !secrets.HF_SPACE_REPO_ID || secrets.HF_SPACE_REPO_ID == '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
>>>>>>> 001-fullstack-todo-app

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
<<<<<<< HEAD
          pip install huggingface_hub

      - name: Verify Hugging Face token
        run: |
          if [ -z "${{ secrets.HUGGINGFACE_TOKEN }}" ]; then
            echo "Error: HUGGINGFACE_TOKEN is not set"
            exit 1
          fi

      - name: Deploy to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          # Configure git for Hugging Face
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # Clone the Hugging Face Space repository
          HF_SPACE_URL="https://oauth2:${HF_TOKEN}@huggingface.co/spaces/${{ secrets.HUGGINGFACE_USERNAME }}/aido-todo-api"
          git clone $HF_SPACE_URL hf-space

          # Copy all necessary files to the HF space directory
          cp -r backend/src hf-space/backend/
          cp -r backend/tests hf-space/backend/  # Include tests for CI/CD
          cp -r backend/requirements.txt hf-space/
          cp -r backend/pyproject.toml hf-space/
          cp -r backend/alembic* hf-space/backend/  # Include alembic migrations
          cp -r Dockerfile hf-space/
          cp -r README.md hf-space/

          # Copy any config files
          if [ -f "backend/.env.example" ]; then
            cp backend/.env.example hf-space/backend/
          fi

          # Commit and push to Hugging Face
          cd hf-space
          git add .
          git status  # Show what files are being added

          if ! git diff --staged --quiet; then
            git commit -m "Update from GitHub Actions [skip ci]"
            git push origin main
            echo "âœ… Backend deployed to Hugging Face Spaces"
          else
            echo "â„¹ï¸ No changes to deploy"
          fi

      - name: Verify deployment
        run: |
          # Wait a bit for the deployment to take effect
          sleep 30

          # Try to check if the API is responding
          API_URL="https://${{ secrets.HUGGINGFACE_USERNAME }}-aido-todo-api.hf.space"
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" $API_URL)

          if [ $HTTP_CODE -eq 200 ] || [ $HTTP_CODE -eq 404 ]; then
            echo "âœ… API is responding (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ API might not be responding properly (HTTP $HTTP_CODE)"
          fi

      - name: Deployment summary
        run: |
          echo "âœ… Backend deployed to Hugging Face Spaces"
          echo "URL: https://huggingface.co/spaces/${{ secrets.HUGGINGFACE_USERNAME }}/aido-todo-api"
          echo "API Endpoint: https://${{ secrets.HUGGINGFACE_USERNAME }}-aido-todo-api.hf.space"
=======
          pip install -r backend/requirements.txt
        working-directory: .

      - name: Run tests
        run: |
          pip install pytest pytest-cov
          python -m pytest backend/tests/ -v
        working-directory: .
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}

      - name: Deploy to Hugging Face using API
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          # Use Hugging Face API to update the space
          pip install requests

          python << 'EOF'
          import os
          import requests
          import zipfile
          import io

          # Configuration
          hf_token = os.environ['HF_ACCESS_TOKEN']
          repo_id = os.environ['HF_SPACE_REPO_ID'] or os.environ.get('GITHUB_REPOSITORY', '').replace('/', '/')
          backend_dir = 'backend'

          headers = {
              'Authorization': f'Bearer {hf_token}'
          }

          # Create a zip of the backend directory
          zip_buffer = io.BytesIO()
          with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
              for root, dirs, files in os.walk(backend_dir):
                  for file in files:
                      file_path = os.path.join(root, file)
                      arc_path = os.path.relpath(file_path, backend_dir)
                      zip_file.write(file_path, arc_path)

          zip_buffer.seek(0)

          # Upload to Hugging Face Space
          upload_url = f'https://huggingface.co/api/spaces/{repo_id}/upload'
          files = {'file': ('backend.zip', zip_buffer, 'application/zip')}
          response = requests.post(upload_url, headers=headers, files=files)

          if response.status_code == 200:
              print(f'Successfully uploaded backend to {repo_id}')
          else:
              print(f'Failed to upload: {response.status_code} - {response.text}')
          EOF
        env:
          HF_ACCESS_TOKEN: ${{ secrets.HF_ACCESS_TOKEN }}
          HF_SPACE_REPO_ID: ${{ secrets.HF_SPACE_REPO_ID }}
>>>>>>> 001-fullstack-todo-app
