name: Deploy Backend to HuggingFace Spaces

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-huggingface.yml'
      - 'docker-compose.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to HuggingFace Spaces
    environment:
      name: huggingface-spaces
      url: https://huggingface.co/spaces/${{ secrets.HUGGINGFACE_USERNAME }}/aido-todo-api

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git for HuggingFace
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Add HuggingFace remote
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
          HF_USERNAME: ${{ secrets.HUGGINGFACE_USERNAME }}
        run: |
          git remote add huggingface "https://huggingface.co/spaces/${HF_USERNAME}/aido-todo-api"
          git remote set-url huggingface "https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/aido-todo-api.git"

      - name: Push to HuggingFace Spaces
        run: |
          git push -f huggingface main:main
        continue-on-error: true

      - name: Create HuggingFace Spaces README
        env:
          HF_USERNAME: ${{ secrets.HUGGINGFACE_USERNAME }}
        run: |
          cat > HUGGINGFACE_README.md << 'EOF'
          ---
          title: AIDO Todo API
          emoji: ðŸ“
          colorFrom: blue
          colorTo: green
          sdk: docker
          app_port: 8000
          ---

          # AIDO Todo API - HuggingFace Spaces

          This is the AIDO Todo application backend deployed on HuggingFace Spaces.

          ## Features

          - FastAPI backend with PostgreSQL database
          - JWT authentication
          - REST API for todo management
          - Health check endpoint at `/health`
          - Interactive API documentation at `/docs`

          ## Environment Variables

          Required:
          - `DATABASE_URL`: PostgreSQL connection string
          - `JWT_SECRET`: Secret key for JWT signing

          Optional:
          - `API_HOST`: API host (default: 0.0.0.0)
          - `API_PORT`: API port (default: 8000)
          - `FRONTEND_URL`: Frontend URL for CORS
          - `ENVIRONMENT`: Environment mode (development/production)

          ## API Endpoints

          - `GET /health` - Health check
          - `POST /auth/signup` - User registration
          - `POST /auth/login` - User login
          - `GET /tasks` - List user tasks
          - `POST /tasks` - Create new task
          - `PUT /tasks/{id}` - Update task
          - `DELETE /tasks/{id}` - Delete task

          ## Documentation

          - Swagger UI: `/docs`
          - ReDoc: `/redoc`

          ## Deployment Notes

          This space is automatically deployed from the GitHub repository.
          Pushing to the main branch triggers a new deployment.
          EOF

      - name: Verify Deployment
        run: |
          echo "Deployment triggered to HuggingFace Spaces"
          echo "Repository: https://huggingface.co/spaces/${{ secrets.HUGGINGFACE_USERNAME }}/aido-todo-api"
          echo "Note: Allow 2-3 minutes for the space to build and start"

      - name: Comment on PR/Commit
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `ðŸš€ Backend deployment to HuggingFace Spaces initiated!\n\nSpace URL: https://huggingface.co/spaces/${{ secrets.HUGGINGFACE_USERNAME }}/aido-todo-api\n\nThe space will be ready in 2-3 minutes. You can monitor the build progress in the HuggingFace Spaces dashboard.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
