name: Error Handling and Notifications

on:
  workflow_run:
    workflows: ["Full CI/CD Pipeline", "Comprehensive Testing Suite"]
    types: [completed]

jobs:
  notify-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    name: Notify on Failure
    steps:
      - name: Get workflow information
        run: |
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Repository: ${{ github.event.repository.full_name }}"
          echo "Commit SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"

      - name: Slack Notification on Failure
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: ':x: ${{ github.event.workflow_run.name }} failed in ${{ github.event.repository.full_name }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Email Notification on Failure
        if: ${{ secrets.EMAIL_SERVICE_URL != '' }}
        run: |
          # Placeholder for email notification
          echo "Sending email notification about failed workflow..."

  notify-on-success:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Notify on Success
    steps:
      - name: Slack Notification on Success
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: ':white_check_mark: ${{ github.event.workflow_run.name }} succeeded in ${{ github.event.repository.full_name }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  create-issue-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    name: Create Issue on Failure
    steps:
      - name: Create Issue for Failed Deployment
        if: ${{ secrets.GITHUB_TOKEN != '' }}
        uses: dacbd/create-issue-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: '[Auto] Failed Deployment - ${{ github.event.workflow_run.name }}'
          body: |
            Automated issue created due to failed workflow run.

            - Workflow: `${{ github.event.workflow_run.name }}`
            - Repository: `${{ github.event.repository.full_name }}`
            - Branch: `${{ github.event.workflow_run.head_branch }}`
            - Commit: `${{ github.event.workflow_run.head_sha }}`
            - Event: `${{ github.event.workflow_run.event }}`
            - URL: ${{ github.event.workflow_run.html_url }}

            Please investigate and resolve the issue.
          labels: 'bug,deployment,automated'